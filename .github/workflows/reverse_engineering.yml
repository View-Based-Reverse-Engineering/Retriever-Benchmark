name: Reverse-Engineer Case Studies

on:
  workflow_dispatch:

  # Every day at 2:00.
  schedule:
  - cron: '0 2 * * *'

jobs:
  find_dirs:
    runs-on: ubuntu-latest
    
    outputs:
      array: ${{ steps.find_directories.outputs.array }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Find directories
        id: find_directories
        run: |
          array=$( \
            printf '[%s]' "$(find . -maxdepth 1 -type d -exec test -e "{}/file_name" ';' -printf '"%P",' | sed 's/\.\///g; s/,$//')" \
          )
          echo "array=$array" >> $GITHUB_OUTPUT

  generate_pcm:
    runs-on: ubuntu-latest
    needs: find_dirs
    strategy:
      matrix:
        directory: ${{ fromJson(needs.find_dirs.outputs.array) }}

    steps:
      - name: Checkout benchmark repository
        uses: actions/checkout@v3
        
      - name: Install yq
        run: sudo apt-get update && sudo apt-get install yq -y
        
      - name: Parse .ruleengine.yml
        run: |
          CONFIG_FILE=${{ matrix.directory }}/.ruleengine.yml
          echo "repository=$(yq '.repository' $CONFIG_FILE)" >> GITHUB_ENV
          echo "current_version=$(yq '.current_version' $CONFIG_FILE)" >> GITHUB_ENV

      - name: Get latest RuleEngine version
        run: |
          LATEST_VERSION=$(\
            curl -sL ${{ github.api_url }}/repos/PalladioSimulator/Palladio-ReverseEngineering-SoMoX-RuleEngine/releases/latest \
            | jq  -r ".tag_name"
          )
          echo "latest_version=$LATEST_VERSION" >> $GITHUB_ENV

      - name: Create temporary directory
        if: ${{ env.latest_version != env.current_verion }}
        run: |
          TEMP_DIR=$(mktemp -d)
          echo "temp_dir=$TEMP_DIR" >> $GITHUB_ENV

      - name: Checkout repository
        if: ${{ env.latest_version != env.current_verion }}
        uses: actions/checkout@v3
        with:
          path: ${{ env.temp_dir }}
          repository: ${{ env.repository }}

      - name: Run RuleEngine on ${{ env.repostory }}
        if: ${{ env.latest_version != env.current_verion }}
        uses: FloBoJa/Palladio-ReverseEngineering-SoMoX-RuleEngine@master
        with:
          source_path: ${{ env.temp_dir }}

      - name: Update version
        if: ${{ env.latest_version != env.current_version }}
        run: yq -i '.current_version = ${{ env.latest_version }}' ${{ matrix.directory }}/.ruleengine.yml
        
      - name: Remove temporary directory
        run: rm -rf ${{ env.temp_dir }}
