name: Reverse-Engineer Case Studies

on:
  workflow_dispatch:

  # Every day at 2:00.
  schedule:
  - cron: '0 2 * * *'

permissions: write-all

jobs:
  generate_pcm:
    runs-on: ubuntu-latest

    steps:
      - name: Get latest RuleEngine version
        run: |
          LATEST_VERSION=$(\
            curl -sL https://api.github.com/repos/PalladioSimulator/Palladio-ReverseEngineering-SoMoX-RuleEngine/releases/latest \
            | jq  -r ".tag_name"
          )
          echo "latest_version=$LATEST_VERSION" >> $GITHUB_ENV

      - name: Run RuleEngine
        if: ${{ env.latest_version != vars.CURRENT_RULE_ENGINE_VERSION }}
        uses: PalladioSimulator/Palladio-ReverseEngineering-SoMoX-RuleEngine@master

      - name: Update version
        if: ${{ env.latest_version != vars.CURRENT_RULE_ENGINE_VERSION }}
        run: |
          curl -L \
          -X PATCH \
          -H "Accept: application/vnd.github+json" \
          -H "Authorization: Bearer ${{ github.token }}" \
          https://api.github.com/api/v3/repos/FloBoJa/ArDoCoBenchmark/actions/variables/CURRENT_RULE_ENGINE_VERSION \
          -d '{"name":"CURRENT_RULE_ENGINE_VERSION","value":"${{ env.latest_version }}"}'
